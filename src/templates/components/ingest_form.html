<div class="bg-card border border-stone-200 shadow-lg rounded-2xl p-8 sm:p-10">
    <!-- Ingest Form -->
    <form id="ingestForm" method="post" onsubmit="handleSubmit(event, true)">
        <!-- Top row: repo URL + Ingest button -->
        <div class="flex md:flex-row flex-col w-full h-full justify-center items-stretch space-y-4 md:space-y-0 md:space-x-4">
            <!-- Repository URL Input -->
            <div class="w-full">
                <input type="text"
                       name="input_text"
                       id="input_text"
                       placeholder="https://github.com/..."
                       value="{{ repo_url if repo_url else '' }}"
                       required
                       class="border border-stone-300 w-full placeholder-stone-400 text-lg font-medium focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary py-3.5 px-6 rounded-xl bg-white transition-all">
            </div>
            <!-- Ingest button -->
            <div class="flex-shrink-0">
                <button type="submit"
                        class="py-3.5 rounded-xl px-8 w-full md:w-auto bg-primary text-primary-foreground hover:bg-primary-hover font-semibold tracking-wide text-lg shadow-sm transition-all flex items-center justify-center gap-2">
                    <i class="ti ti-bolt text-lg"></i>
                    Ingest
                </button>
            </div>
        </div>
        <!-- Preset profiles -->
        <div class="mt-5 flex flex-wrap items-center gap-2">
            <span class="text-sm text-muted-foreground font-medium mr-1">Presets:</span>
            <button type="button" data-preset="code-review" onclick="applyPreset('code-review')"
                    class="px-3.5 py-1.5 text-sm bg-secondary border border-stone-200 rounded-full transition-all hover:bg-accent hover:text-accent-foreground hover:border-cyan-300">
                Code Review
            </button>
            <button type="button" data-preset="documentation" onclick="applyPreset('documentation')"
                    class="px-3.5 py-1.5 text-sm bg-secondary border border-stone-200 rounded-full transition-all hover:bg-accent hover:text-accent-foreground hover:border-cyan-300">
                Documentation
            </button>
            <button type="button" data-preset="architecture" onclick="applyPreset('architecture')"
                    class="px-3.5 py-1.5 text-sm bg-secondary border border-stone-200 rounded-full transition-all hover:bg-accent hover:text-accent-foreground hover:border-cyan-300">
                Architecture
            </button>
            <button type="button" data-preset="full-digest" onclick="applyPreset('full-digest')"
                    class="px-3.5 py-1.5 text-sm bg-secondary border border-stone-200 rounded-full transition-all hover:bg-accent hover:text-accent-foreground hover:border-cyan-300">
                Full Digest
            </button>
        </div>
        <!-- Hidden fields -->
        <input type="hidden" name="pattern_type" value="exclude">
        <input type="hidden" name="pattern" value="">
        <!-- Controls row: pattern selector, file size slider, PAT checkbox with PAT field below -->
        <div id="controlsRow"
             class="mt-7 grid gap-6 grid-cols-1 sm:grid-cols-[3fr_2fr] md:gap-x-10 lg:grid-cols-[4fr_3fr_3fr_3fr_3fr] lg:gap-y-0">
            <!-- Pattern selector -->
            <div class="w-full relative self-center">
                <div class="flex border border-stone-300 rounded-lg bg-white overflow-hidden focus-within:ring-2 focus-within:ring-primary focus-within:border-primary transition-all">
                    <!-- Pattern type selector -->
                    <div class="relative flex items-center">
                        <select id="pattern_type"
                                name="pattern_type"
                                onchange="changePattern()"
                                class="pattern-select rounded-l-lg">
                            <option value="exclude"
                                    {% if pattern_type == 'exclude' or not pattern_type %}selected{% endif %}>
                                Exclude
                            </option>
                            <option value="include" {% if pattern_type == 'include' %}selected{% endif %}>Include</option>
                        </select>
                        <svg class="absolute right-2 w-3.5 h-3.5 pointer-events-none text-stone-500"
                             xmlns="http://www.w3.org/2000/svg"
                             viewBox="0 0 24 24"
                             fill="none"
                             stroke="currentColor"
                             stroke-width="2"
                             stroke-linecap="round"
                             stroke-linejoin="round">
                            <polyline points="6 9 12 15 18 9" />
                        </svg>
                    </div>
                    <!-- Pattern input field -->
                    <input type="text"
                           id="pattern"
                           name="pattern"
                           placeholder="*.md, src/ "
                           value="{{ pattern if pattern else '' }}"
                           class="py-2 px-3 bg-white focus:outline-none w-full text-sm">
                </div>
            </div>
            <!-- File size selector -->
            <div class="w-full self-center">
                <label for="file_size" class="block text-stone-600 text-sm mb-1.5">
                    Include files under: <span id="size_value" class="font-semibold text-foreground">50kB</span>
                </label>
                <input type="range"
                       id="file_size"
                       min="1"
                       max="500"
                       required
                       value="{{ default_max_file_size }}"
                       class="w-full h-2 bg-stone-200 appearance-none rounded-full focus:outline-none [&::-webkit-slider-thumb]:w-4 [&::-webkit-slider-thumb]:h-4 [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:bg-white [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:cursor-pointer [&::-webkit-slider-thumb]:border-2 [&::-webkit-slider-thumb]:border-primary [&::-webkit-slider-thumb]:shadow-sm">
                <input type="hidden" id="max_file_size_kb" name="max_file_size" value="">
            </div>
            <!-- Output format selector -->
            <div class="w-full self-center">
                <label for="output_format" class="block text-stone-600 text-sm mb-1.5">
                    Output format
                </label>
                <div class="relative w-full">
                    <select id="output_format"
                            name="output_format"
                            class="w-full py-2 px-3 bg-white border border-stone-300 rounded-lg appearance-none focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary cursor-pointer text-sm transition-all">
                        <option value="text" selected>Text</option>
                        <option value="json">JSON</option>
                        <option value="markdown">Markdown</option>
                        <option value="xml">XML</option>
                    </select>
                    <svg class="absolute right-3 top-1/2 -translate-y-1/2 w-3.5 h-3.5 pointer-events-none text-stone-500"
                         xmlns="http://www.w3.org/2000/svg"
                         viewBox="0 0 24 24"
                         fill="none"
                         stroke="currentColor"
                         stroke-width="2"
                         stroke-linecap="round"
                         stroke-linejoin="round">
                        <polyline points="6 9 12 15 18 9" />
                    </svg>
                </div>
            </div>
            <!-- Chunk for model selector -->
            <div class="w-full self-center">
                <label for="target_model" class="block text-stone-600 text-sm mb-1.5">
                    Chunk for model
                </label>
                <div class="relative w-full">
                    <select id="target_model"
                            name="target_model"
                            class="w-full py-2 px-3 bg-white border border-stone-300 rounded-lg appearance-none focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary cursor-pointer text-sm transition-all">
                        <option value="" selected>None (full digest)</option>
                        <option value="GPT-4o">GPT-4o (128k)</option>
                        <option value="Claude">Claude (200k)</option>
                        <option value="Gemini">Gemini (2M)</option>
                        <option value="Llama 3">Llama 3 (128k)</option>
                    </select>
                    <svg class="absolute right-3 top-1/2 -translate-y-1/2 w-3.5 h-3.5 pointer-events-none text-stone-500"
                         xmlns="http://www.w3.org/2000/svg"
                         viewBox="0 0 24 24"
                         fill="none"
                         stroke="currentColor"
                         stroke-width="2"
                         stroke-linecap="round"
                         stroke-linejoin="round">
                        <polyline points="6 9 12 15 18 9" />
                    </svg>
                </div>
            </div>
            <!-- PAT checkbox with PAT field below -->
            <div class="flex flex-col items-start w-full sm:col-span-2 lg:col-span-1 lg:row-span-2 lg:pt-3.5">
                <!-- PAT checkbox -->
                <div class="flex items-center space-x-2">
                    <label for="showAccessSettings"
                           class="flex gap-2 text-foreground cursor-pointer text-sm">
                        <div class="relative w-5 h-5">
                            <input type="checkbox"
                                   id="showAccessSettings"
                                   onchange="toggleAccessSettings()"
                                   {% if token %}checked{% endif %}
                                   class="cursor-pointer peer appearance-none w-full h-full rounded border-2 border-stone-300 bg-white m-0 checked:bg-primary checked:border-primary transition-all" />
                            <span class="absolute inset-0 w-2.5 h-2.5 m-auto scale-0 transition-transform duration-150 ease-in-out shadow-[inset_1rem_1rem_white] bg-[CanvasText] origin-bottom-left peer-checked:scale-100"
                                  style="clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%)"></span>
                        </div>
                        Private Repository
                    </label>
                </div>
                <!-- PAT field -->
                <div id="accessSettingsContainer"
                     class="{% if not token %}hidden {% endif %}mt-3 w-full">
                    <div class="relative w-full">
                        <div class="flex border border-stone-300 rounded-lg bg-white overflow-hidden focus-within:ring-2 focus-within:ring-primary focus-within:border-primary transition-all">
                            <input id="token"
                                   type="password"
                                   name="token"
                                   placeholder="Personal Access Token"
                                   value="{{ token if token else '' }}"
                                   class="py-2 pl-3 pr-8 bg-white focus:outline-none w-full rounded-lg text-sm">
                            <!-- Info icon with tooltip -->
                            <span class="absolute right-3 top-1/2 -translate-y-1/2">
                                <!-- Icon -->
                                <svg class="w-4 h-4 text-stone-400 cursor-pointer peer hover:text-stone-600 transition-colors"
                                     xmlns="http://www.w3.org/2000/svg"
                                     fill="none"
                                     viewBox="0 0 24 24"
                                     stroke="currentColor"
                                     stroke-width="2">
                                    <circle cx="12" cy="12" r="10" />
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 16v-4m0-4h.01" />
                                </svg>
                                <!-- Tooltip -->
                                <div class="absolute bottom-full mb-2 left-1/2 -translate-x-1/2 bg-foreground text-background text-xs leading-tight py-2 px-3 rounded-lg shadow-lg opacity-0 pointer-events-none peer-hover:opacity-100 peer-hover:pointer-events-auto transition-opacity duration-200 whitespace-nowrap">
                                    <ul class="list-disc pl-4 space-y-0.5">
                                        <li>PAT is never stored in the backend</li>
                                        <li>Used once for cloning, then discarded from memory</li>
                                        <li>No browser caching</li>
                                        <li>Cloned repos are deleted after processing</li>
                                    </ul>
                                </div>
                            </span>
                        </div>
                    </div>
                    <!-- Help section -->
                    <div class="mt-2 flex items-center space-x-1">
                        <a href="https://github.com/settings/tokens/new?description=gitunderstand&scopes=repo"
                           target="_blank"
                           rel="noopener noreferrer"
                           class="text-sm text-primary hover:text-primary-hover flex items-center space-x-1 underline transition-colors">
                            <span>Get your token</span>
                            <svg class="w-3 h-3"
                                 fill="none"
                                 stroke="currentColor"
                                 viewBox="0 0 24 24"
                                 xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                            </svg>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </form>
    <!-- Example repositories section -->
    {% if show_examples %}
        <div id="exampleRepositories"
             class="{% if token %}lg:mt-0 {% endif %} mt-5">
            <p class="text-sm text-muted-foreground mb-2">Try these example repositories:</p>
            <div class="flex flex-wrap gap-2">
                {% for example in examples %}
                    <button onclick="submitExample('{{ example.url }}')"
                            class="px-3.5 py-1.5 bg-secondary hover:bg-accent hover:text-accent-foreground text-foreground rounded-full transition-all text-sm border border-stone-200 hover:border-cyan-300">
                        {{ example.name }}
                    </button>
                {% endfor %}
            </div>
        </div>
    {% endif %}
</div>
<script defer src="/static/js/ingest.js"></script>
